#!/usr/bin/env perl

use strict;
use warnings;
use utf8;
use v5.14;

use lib qw (lib);
use GrowBot;

# Set the script name.
$0 = "growbot";

# The configuration file to load.
my $configFile = "config.json";

# Create a PID file.
open my $pid, ">", "growbot.pid" or die "Could not write to PID file: $!";
print $pid "$$\n";
close $pid;

# Create a new GrowBot using the configuration file.
my $growbot = GrowBot->new ($configFile);

# Capture SIGINT, and SIGTERM to allow for a graceful exit.
$SIG{INT} = $SIG{TERM} = sub {
  foreach my $device ($growbot->devices) {
    $growbot->enqueueCommand ($device, "Close");
  }
};

printf "%s %s\n", $growbot->name, $growbot->version;

# Start the GrowBot.
$growbot->start;

# Wait for the Growbot to finish.
$growbot->wait;

# Close the GrowBot.
$growbot->close;

printf "Done.\n";

# Remove the PID file.
unlink "growbot.pid" or die "Count not remove PID file: $!";
